# 피크월(거래량 기준)

## 목표
   이것의 목표는 손오공과 같이 특정 월에 몰리는 거래량을 가진 종목을 찾아서 매매할떄 참고하기 위함이다.   
   연도별 분기, 연도별 월, 연도별 주 단위로 구분하여 거래량이 몰리는 연도별 단위의 피크점를 찾은 후에 전체연도의 단위의 피크점과 연도별 단위의 피크점의 백분율을 구하여 백분율 순위 출력하기.


## 주요 용어
* 단위 구분   
  * 연도별 분기 quarter by year
  * 연도별 월 month by year
  * 연도별 주 weeks by year
* 단위의 피크점 unit peak





## 피크월 계산 방법
   - 기존
     1. 종목의 거래량을 월별단위로 평균, 최고, 최소, 합의 집계를 낸다.
     2. 종목의 연도단위로 평균거래량을 구한다.
     3. 종목의 연도단위의 평균거래량 보다 큰 월의 수의 범위를 구한다.
     4. 평균 거래량 보다 큰 범위의 수가 5개 이하면 굿이다.
     5. 범위의 수를 연결되어야 한다. 
        1. 11,12,1 이거나 10,11,12 이거나 이런식으로
     6. 가공 데이터 종목, 범위, 제일큰 수 를 저장한다.
     ----
   - 변경
      
      1. 장열림 테이블에 거래일이 해당연도의 몇주, 몇 분기에 해당하는지 구한다.
      2. 종목의 연도별 주단위로 거래량의 합을 구한다.
         1. 종목의 해당연도의 일자에 해당하는 주가 몇번째 주인지 구하기
         2. 해당연도의 주별 거래량 합 구하기
      3. 해당연도의 주단위로 평균거래량, 최고거래량인 주, 최소거래량인 주를 찾는다.
         1. 해당연도의 주단위로 평균거래량 보다 큰 주의 목록, 평균거래량 보다 작은 주의 목록 구한다.
         2. 목록마다 연결성의 존재 여부를 찾는다.
 
      4. 전체년도의 주단위 ***빈도분석*** : 전체연도로 놓고 연도별 최고거래량인 주, 최소거래량인 주, 평균거래량보다 큰 목록의 주, 평균거래량 보다 작은 목록의 주가 몇 퍼센트를 찾는다.
         1. 연도별 종목의 주단위 거래량의 빈도 분석

## 테이블

   1. 빈도 테이블 
      | 종목id | 최고거래량인 주 | 최고거래량인 주의 퍼센트 | 최소거래량인 주 | 최소거래량인 주의 퍼센트 | 평균 최소 범위 | 평균 최소 범위의 퍼센트 | 평균 최대 범위 | 평균 최대 범위의 퍼센트 |
      | ------ | --------------- | ------------------------ | --------------- | ------------------------ | -------------- | ----------------------- | -------------- | ----------------------- |

   2. 연도별 주  단위 테이블
      | 종목id | 연도 | 최고거래량인 주 | 최소거래량인 주 | 평균 이상의 주 목록 | 평균 이하의 주 목록 |
      | ------ | ---- | --------------- | --------------- | ------------------ | ------------------ |

   3. 연도별 분기 단위 테이블
       | 종목id | 연도 | 최고거래량인 분기 | 최소거래량인 분기 | 평균 이상의 분기 목록 | 평균 이하의 분기 목록 |
       | ------ | ---- | --------------- | --------------- | ------------------ | ------------------ |

   4. 연도별 월 단위 테이블
      | 종목id | 연도 | 최고거래량인 월 | 최소거래량인 월 | 평균 이상의 월 목록 | 평균 이하의 월 목록 |
      | ------ | ---- | --------------- | --------------- | ------------------ | ------------------ |

   5. 주별 테이블 
      1. 저장소 낭비
         1. 2000(종목수) * (종목별)전체년도 수 * 52(주) 의 줄 발생
         2. rdb말고 nosql db로 한다면?
         
      2. 연도 파티션 테이블
      
      | 종목id | 연도 | 주  | 거래량의 합 |
      | ------ | ---- | --- | ----------- |




## 테이블
   - 임시테이블
     - 연도의 주별 거래량 : 이것을 매일 업데이트 하고
       - 주별 거래량을 가지고 월별, 분기별 거래량을 갱신한다.
     
   | 종목id | 연도 | 단위구분 | 거래량 |
   | ------ | ---- | -------- | ------ |
   
   - 계산결과 테이블
     - 년도별 파티션

   | 종목id | 연도 | 단위구분 | 단위의 피크값 |
   | ------ | ---- | -------- | ------------- |

   - 통계뷰
   
  | 종목id | 단위구분 | 전체연도 단위의 피크값 | 전체연도 단위의 피크값 범위 | 퍼센트 |
  | ------ | -------- | ---------------------- | --------------------------- | ------ |
  

## 실행주기 파이프라인

   - 매일 입력되는 데이터 기준으로? 
     - 입력 데이터가 현재의 것이라면
       - 현재 데이터와 연관된 단위의 테이블값을 수정함.
     - 입력 데이터가 과거의 것이라면
       - 과거 시점부터 현재까지의 데이터까지 연관된 단위의 테이블값을 수정함.
   - 저장테이블을 기준으로?
 
  
  





## 구체적인 방법
1. vscode를 켠다. 
2. 쿼리를 짠다.
   1. meta.code에 해당되는 tb_monthly_peek의  기준칼럼(마지막 저장일)을 찾아서 계산해서 넣기
      1. meta.code와 tb_monthly_peek의 기준칼럼(마지막 저장일)을 조회
         1. table 생성 tb_monthly_peek tbmp, tb_monthly_peek_volume tbmpv
            1. 차이점: 
               1. tbmp는 매일 업데이트된 tbmpv의 거래럍을 가지고 정보를 도출한다.
               2. tbmpv는 단순히 매일 거래량을 업데이트한다.  
         2. tbmp     => 종목의 연도별 피크월, 사용자 조회= 마지막 테이블 
         3. tbmpv    => 년도의 월별 거래량합, tb_monthly_peek의 보조
            1. 종목코드, 년도, 월, 거래량, 마지막계산일
            2. 장마감시 거래량 업데이트 용


         4. 매일 tb_mpv의 년도의 월에 vol 추가하고
         5. tb_mp에 종목의 해당년도의 값 업데이트 하기.
         6. 
      2. 시작기준 부터 hist.price 조회
      3. 조회 결과 golang으로 계산
      4. insert
3. 맞나 확인한다.
4. 테이블 저장: 코드의 전체년도의 피크월 존재, 피크월, 주변월, 전체월.json{월: 퍼센트} 
5. 뷰 저장: select count(피크월) group by 피크월  count 가 1이면 피크윌이 공통값.   
    where row수가  1이 아니것의 의미는 => 여러 년도를 비교한것. 그러므로 조회에서 로우수도 조회

## 계산 범위
현재 입력된 달은 매일 갱신.   
매일 테이블을 갱신 시켜줌. 해당년도의 달만.    
하루에 2번 실행 될 되도 문제없게.  

## 실행시작
가격다 넣고 반등 계산하고.   
종목별 마지막 가격일 조회 해서 가격일 갱신하면 이전 피크월은 계산이 안됨.   

피크월 테이블 기준으로 시작하기 vs 가격 테이블 기준 시작하기   
종목의 마지막 년도 피크월이 있으면? ( 년도포함월 칼럼추가. )    
